#!/bin/sh
#
# Pre-commit hook para validar código Go antes do commit
#

set -e

# Cores para output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

echo "${GREEN}Running pre-commit checks...${NC}"

# Verifica se há arquivos Go staged
STAGED_GO_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '\.go$' || true)

if [ -z "$STAGED_GO_FILES" ]; then
    echo "${YELLOW}No Go files staged, skipping Go checks${NC}"
    exit 0
fi

echo "${GREEN}Found staged Go files, running checks...${NC}"

# 1. Formatação com gofmt
echo "${GREEN}[1/5] Checking code formatting (gofmt)...${NC}"
UNFORMATTED=$(gofmt -l $STAGED_GO_FILES 2>/dev/null || true)
if [ -n "$UNFORMATTED" ]; then
    echo "${RED}❌ Code is not formatted. Please run: gofmt -w .${NC}"
    echo "$UNFORMATTED"
    exit 1
fi
echo "${GREEN}✓ Code formatting OK${NC}"

# 2. Verificação com go vet
echo "${GREEN}[2/5] Running go vet...${NC}"
for file in $STAGED_GO_FILES; do
    if ! go vet "./$file" 2>/dev/null; then
        echo "${RED}❌ go vet failed for $file${NC}"
        exit 1
    fi
done
echo "${GREEN}✓ go vet OK${NC}"

# 3. Linting com golangci-lint (se disponível)
if command -v golangci-lint >/dev/null 2>&1; then
    echo "${GREEN}[3/5] Running golangci-lint...${NC}"
    if ! golangci-lint run --new-from-rev=HEAD~1 2>/dev/null; then
        echo "${YELLOW}⚠ golangci-lint found issues (non-blocking)${NC}"
    else
        echo "${GREEN}✓ golangci-lint OK${NC}"
    fi
else
    echo "${YELLOW}[3/5] golangci-lint not found, skipping${NC}"
fi

# 4. Verificar imports não utilizados
echo "${GREEN}[4/5] Checking for unused imports...${NC}"
if ! goimports -l $STAGED_GO_FILES 2>/dev/null | grep -q .; then
    echo "${GREEN}✓ No unused imports${NC}"
else
    echo "${RED}❌ Unused imports found. Please run: goimports -w .${NC}"
    exit 1
fi

# 5. Verificar que não há arquivos de teste quebrados
echo "${GREEN}[5/5] Running tests for changed packages...${NC}"
CHANGED_PACKAGES=$(echo "$STAGED_GO_FILES" | xargs -n1 dirname | sort -u | grep -v '^\.$' || true)
if [ -n "$CHANGED_PACKAGES" ]; then
    for pkg in $CHANGED_PACKAGES; do
        # Pula se não for um pacote Go válido
        if [ ! -f "$pkg" ] && [ -d "$pkg" ]; then
            if ! go test -short "./$pkg" 2>/dev/null; then
                echo "${YELLOW}⚠ Tests failed for $pkg (non-blocking in pre-commit)${NC}"
            fi
        fi
    done
fi
echo "${GREEN}✓ Pre-commit checks passed!${NC}"

exit 0

