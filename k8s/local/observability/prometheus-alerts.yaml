# Prometheus Alerting Rules for LeetGaming Platform
apiVersion: v1
kind: ConfigMap
metadata:
  name: prometheus-alerts
  namespace: leetgaming
data:
  alerts.yml: |
    groups:
      - name: leetgaming-api
        rules:
          - alert: APIHighErrorRate
            expr: sum(rate(http_requests_total{job="replay-api", status=~"5.."}[5m])) / sum(rate(http_requests_total{job="replay-api"}[5m])) > 0.05
            for: 2m
            labels:
              severity: critical
              service: replay-api
            annotations:
              summary: "High API error rate detected"
              description: "API error rate is {{ $value | humanizePercentage }} (threshold: 5%)"

          - alert: APIHighLatency
            expr: histogram_quantile(0.95, sum(rate(http_request_duration_seconds_bucket{job="replay-api"}[5m])) by (le)) > 1
            for: 5m
            labels:
              severity: warning
              service: replay-api
            annotations:
              summary: "High API latency detected"
              description: "95th percentile latency is {{ $value | humanizeDuration }} (threshold: 1s)"

          - alert: APIDown
            expr: up{job="replay-api"} == 0
            for: 1m
            labels:
              severity: critical
              service: replay-api
            annotations:
              summary: "API is down"
              description: "The replay-api service has been down for more than 1 minute"

          - alert: APIHighMemoryUsage
            expr: go_memstats_alloc_bytes{job="replay-api"} > 500 * 1024 * 1024
            for: 5m
            labels:
              severity: warning
              service: replay-api
            annotations:
              summary: "High API memory usage"
              description: "API memory usage is {{ $value | humanize1024 }}B (threshold: 500MB)"

          - alert: APIHighGoroutines
            expr: go_goroutines{job="replay-api"} > 1000
            for: 5m
            labels:
              severity: warning
              service: replay-api
            annotations:
              summary: "High number of goroutines"
              description: "API has {{ $value }} goroutines (threshold: 1000)"

      - name: leetgaming-mongodb
        rules:
          - alert: MongoDBDown
            expr: up{job="mongodb"} == 0
            for: 1m
            labels:
              severity: critical
              service: mongodb
            annotations:
              summary: "MongoDB is down"
              description: "MongoDB exporter has been down for more than 1 minute"

          - alert: MongoDBHighConnections
            expr: mongodb_ss_connections{conn_type="current"} > 100
            for: 5m
            labels:
              severity: warning
              service: mongodb
            annotations:
              summary: "High MongoDB connection count"
              description: "MongoDB has {{ $value }} current connections (threshold: 100)"

          - alert: MongoDBConnectionPoolExhausted
            expr: mongodb_ss_connections{conn_type="available"} < 10
            for: 2m
            labels:
              severity: critical
              service: mongodb
            annotations:
              summary: "MongoDB connection pool nearly exhausted"
              description: "Only {{ $value }} connections available"

          - alert: MongoDBHighMemory
            expr: mongodb_ss_mem_resident > 1024
            for: 5m
            labels:
              severity: warning
              service: mongodb
            annotations:
              summary: "High MongoDB memory usage"
              description: "MongoDB resident memory is {{ $value }}MB (threshold: 1GB)"

          - alert: MongoDBSlowOperations
            expr: rate(mongodb_ss_opLatencies_latency{type="reads"}[5m]) / rate(mongodb_ss_opLatencies_ops{type="reads"}[5m]) > 100000
            for: 5m
            labels:
              severity: warning
              service: mongodb
            annotations:
              summary: "MongoDB slow read operations"
              description: "Average read latency is {{ $value | humanize }}Î¼s (threshold: 100ms)"

      # Redis alerts removed - Redis not used in this deployment

      - name: leetgaming-kubernetes
        rules:
          - alert: PodCrashLooping
            expr: increase(kube_pod_container_status_restarts_total{namespace="leetgaming"}[1h]) > 5
            for: 5m
            labels:
              severity: warning
              service: kubernetes
            annotations:
              summary: "Pod crash looping"
              description: "Pod {{ $labels.pod }} has restarted {{ $value }} times in the last hour"

          - alert: PodNotReady
            expr: kube_pod_status_phase{namespace="leetgaming", phase=~"Pending|Unknown"} == 1
            for: 5m
            labels:
              severity: warning
              service: kubernetes
            annotations:
              summary: "Pod not ready"
              description: "Pod {{ $labels.pod }} has been in {{ $labels.phase }} state for more than 5 minutes"

          - alert: HighPodMemoryUsage
            expr: sum(container_memory_working_set_bytes{namespace="leetgaming", container!=""}) by (pod) / sum(kube_pod_container_resource_limits{namespace="leetgaming", resource="memory"}) by (pod) > 0.9
            for: 5m
            labels:
              severity: warning
              service: kubernetes
            annotations:
              summary: "High pod memory usage"
              description: "Pod {{ $labels.pod }} memory usage is at {{ $value | humanizePercentage }} of limit"

          - alert: HighPodCPUUsage
            expr: sum(rate(container_cpu_usage_seconds_total{namespace="leetgaming", container!=""}[5m])) by (pod) / sum(kube_pod_container_resource_limits{namespace="leetgaming", resource="cpu"}) by (pod) > 0.9
            for: 5m
            labels:
              severity: warning
              service: kubernetes
            annotations:
              summary: "High pod CPU usage"
              description: "Pod {{ $labels.pod }} CPU usage is at {{ $value | humanizePercentage }} of limit"

      - name: leetgaming-business
        rules:
          - alert: MatchmakingQueueBacklog
            expr: matchmaking_queue_size > 100
            for: 10m
            labels:
              severity: warning
              service: matchmaking
            annotations:
              summary: "Matchmaking queue backlog"
              description: "Matchmaking queue has {{ $value }} players waiting (threshold: 100)"

          - alert: PaymentFailureRate
            expr: sum(rate(payment_failed_total[5m])) / sum(rate(payment_attempts_total[5m])) > 0.1
            for: 5m
            labels:
              severity: critical
              service: payments
            annotations:
              summary: "High payment failure rate"
              description: "Payment failure rate is {{ $value | humanizePercentage }} (threshold: 10%)"

          - alert: TournamentServiceDegraded
            expr: sum(rate(tournament_errors_total[5m])) > 10
            for: 5m
            labels:
              severity: warning
              service: tournaments
            annotations:
              summary: "Tournament service errors"
              description: "Tournament service has {{ $value }} errors/s (threshold: 10/s)"

      # ===========================================
      # Esports Platform Alerts
      # ===========================================

      - name: leetgaming-matchmaking
        rules:
          - alert: MatchmakingHighWaitTime
            expr: histogram_quantile(0.95, sum(rate(esports_matchmaking_wait_seconds_bucket[5m])) by (le)) > 180
            for: 5m
            labels:
              severity: warning
              service: matchmaking
            annotations:
              summary: "High matchmaking wait time"
              description: "P95 matchmaking wait time is {{ $value | humanizeDuration }} (threshold: 3 minutes)"

          - alert: MatchmakingQueueTimeout
            expr: sum(rate(esports_matchmaking_queue_leaves_total{reason="timeout"}[10m])) / sum(rate(esports_matchmaking_queue_joins_total[10m])) > 0.15
            for: 10m
            labels:
              severity: critical
              service: matchmaking
            annotations:
              summary: "High matchmaking timeout rate"
              description: "{{ $value | humanizePercentage }} of players timing out (threshold: 15%)"

          - alert: MatchmakingSkillImbalance
            expr: histogram_quantile(0.95, sum(rate(esports_matchmaking_skill_spread_bucket[10m])) by (le)) > 500
            for: 10m
            labels:
              severity: warning
              service: matchmaking
            annotations:
              summary: "High skill spread in matches"
              description: "P95 MMR spread is {{ $value }} (threshold: 500)"

          - alert: LobbyReadyCheckFailure
            expr: sum(rate(esports_lobby_ready_check_timeout_total[15m])) > 5
            for: 10m
            labels:
              severity: warning
              service: matchmaking
            annotations:
              summary: "High lobby ready check failures"
              description: "{{ $value }} lobbies cancelled due to ready check timeout in last 15 minutes"

      - name: leetgaming-tournaments
        rules:
          - alert: TournamentLowFillRate
            expr: histogram_quantile(0.50, sum(rate(esports_tournament_fill_percentage_bucket[1h])) by (le)) < 0.5
            for: 30m
            labels:
              severity: warning
              service: tournaments
            annotations:
              summary: "Low tournament fill rate"
              description: "Median tournament fill rate is {{ $value | humanizePercentage }} (threshold: 50%)"

          - alert: TournamentLongMatches
            expr: histogram_quantile(0.95, sum(rate(esports_tournament_match_duration_seconds_bucket[1h])) by (le)) > 3600
            for: 30m
            labels:
              severity: warning
              service: tournaments
            annotations:
              summary: "Tournament matches taking too long"
              description: "P95 match duration is {{ $value | humanizeDuration }} (threshold: 1 hour)"

      - name: leetgaming-kafka
        rules:
          - alert: KafkaDown
            expr: up{job="kafka"} == 0
            for: 1m
            labels:
              severity: critical
              service: kafka
            annotations:
              summary: "Kafka is down"
              description: "Kafka broker has been unreachable for more than 1 minute"

          - alert: KafkaHighConsumerLag
            expr: sum(esports_kafka_consumer_lag) by (topic, consumer_group) > 1000
            for: 5m
            labels:
              severity: warning
              service: kafka
            annotations:
              summary: "High Kafka consumer lag"
              description: "Consumer group {{ $labels.consumer_group }} has {{ $value }} messages lag on topic {{ $labels.topic }}"

          - alert: KafkaCriticalConsumerLag
            expr: sum(esports_kafka_consumer_lag) by (topic, consumer_group) > 10000
            for: 2m
            labels:
              severity: critical
              service: kafka
            annotations:
              summary: "Critical Kafka consumer lag"
              description: "Consumer group {{ $labels.consumer_group }} has {{ $value }} messages lag on topic {{ $labels.topic }}"

          - alert: KafkaSlowProcessing
            expr: histogram_quantile(0.95, sum(rate(esports_kafka_processing_duration_seconds_bucket[5m])) by (le, topic)) > 0.5
            for: 5m
            labels:
              severity: warning
              service: kafka
            annotations:
              summary: "Slow Kafka message processing"
              description: "P95 processing time for topic {{ $labels.topic }} is {{ $value | humanizeDuration }}"

          - alert: KafkaDLQMessages
            expr: sum(increase(esports_kafka_dlq_messages_total[15m])) > 10
            for: 5m
            labels:
              severity: warning
              service: kafka
            annotations:
              summary: "Messages being sent to DLQ"
              description: "{{ $value }} messages sent to dead letter queue in last 15 minutes"

          - alert: KafkaDLQCritical
            expr: sum(increase(esports_kafka_dlq_messages_total[5m])) > 50
            for: 2m
            labels:
              severity: critical
              service: kafka
            annotations:
              summary: "Critical: Many messages going to DLQ"
              description: "{{ $value }} messages sent to dead letter queue in last 5 minutes"

      - name: leetgaming-websocket
        rules:
          - alert: WebSocketHighLatency
            expr: histogram_quantile(0.95, sum(rate(esports_websocket_message_latency_ms_bucket[5m])) by (le)) > 100
            for: 5m
            labels:
              severity: warning
              service: websocket
            annotations:
              summary: "High WebSocket latency"
              description: "P95 message latency is {{ $value }}ms (threshold: 100ms)"

          - alert: WebSocketCriticalLatency
            expr: histogram_quantile(0.99, sum(rate(esports_websocket_message_latency_ms_bucket[5m])) by (le)) > 500
            for: 2m
            labels:
              severity: critical
              service: websocket
            annotations:
              summary: "Critical WebSocket latency"
              description: "P99 message latency is {{ $value }}ms (threshold: 500ms)"

          - alert: WebSocketConnectionDrop
            expr: delta(esports_websocket_connections_total[5m]) < -100
            for: 2m
            labels:
              severity: warning
              service: websocket
            annotations:
              summary: "WebSocket connections dropping"
              description: "Lost {{ $value | humanize }} connections in last 5 minutes"

      - name: leetgaming-players
        rules:
          - alert: LowPlayerEngagement
            expr: sum(esports_active_players_current) < 10
            for: 30m
            labels:
              severity: info
              service: platform
            annotations:
              summary: "Low player activity"
              description: "Only {{ $value }} active players (informational)"

          - alert: ReplayProcessingSlow
            expr: histogram_quantile(0.95, sum(rate(esports_replay_processing_seconds_bucket[1h])) by (le)) > 120
            for: 15m
            labels:
              severity: warning
              service: replay
            annotations:
              summary: "Slow replay processing"
              description: "P95 replay processing time is {{ $value | humanizeDuration }} (threshold: 2 minutes)"
